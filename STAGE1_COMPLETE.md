# é˜¶æ®µä¸€ï¼šåŸºç¡€ç½‘ç»œé€šä¿¡ - å®ŒæˆæŠ¥å‘Š

## æ¦‚è¿°

é˜¶æ®µä¸€æˆåŠŸå®ç°äº†åŸºç¡€TCPå®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡åŠŸèƒ½ï¼Œå¥ å®šäº†æ•´ä¸ªSSHé¡¹ç›®çš„ç½‘ç»œé€šä¿¡åŸºç¡€ã€‚æœ¬é˜¶æ®µå®ç°äº†å¯é çš„TCPè¿æ¥å»ºç«‹ã€æ•°æ®ä¼ è¾“å’Œè¿æ¥ç®¡ç†ï¼Œä¸ºåç»­SSHåè®®çš„å®ç°æä¾›äº†ç¨³å®šçš„ç½‘ç»œé€šä¿¡å±‚ã€‚

## å®ç°å†…å®¹

### 1. TCPæœåŠ¡å™¨å®ç°
- å®ç°äº†å¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥æ”¯æŒ
- æ”¯æŒéé˜»å¡I/Oæ“ä½œ
- æä¾›è¿æ¥çŠ¶æ€ç®¡ç†
- å®ç°äº†ç®€å•çš„å›æ˜¾æœåŠ¡å™¨åŠŸèƒ½

### 2. TCPå®¢æˆ·ç«¯å®ç°
- å®ç°äº†å¯é çš„æœåŠ¡å™¨è¿æ¥å»ºç«‹
- æ”¯æŒç”¨æˆ·äº¤äº’å¼è¾“å…¥
- æä¾›å®æ—¶æœåŠ¡å™¨å“åº”æ˜¾ç¤º
- å®ç°äº†ä¼˜é›…çš„è¿æ¥æ–­å¼€æœºåˆ¶

### 3. ç½‘ç»œå·¥å…·åº“
- å®ç°äº†å®Œæ•´çš„socketå·¥å…·å‡½æ•°é›†
- æä¾›é”™è¯¯å¤„ç†å’ŒçŠ¶æ€ç®¡ç†
- æ”¯æŒè·¨å¹³å°ç½‘ç»œç¼–ç¨‹
- å®ç°äº†ç½‘ç»œæ•°æ®çš„å®‰å…¨æ”¶å‘

### 4. æ—¥å¿—ç³»ç»Ÿ
- å®ç°äº†åˆ†çº§æ—¥å¿—è®°å½•åŠŸèƒ½
- æ”¯æŒå®æ—¶è°ƒè¯•å’Œé—®é¢˜è¯Šæ–­
- æä¾›è¯¦ç»†çš„è¿æ¥çŠ¶æ€è·Ÿè¸ª
- å®ç°äº†çº¿ç¨‹å®‰å…¨çš„æ—¥å¿—è¾“å‡º

## æ ¸å¿ƒåŠŸèƒ½

### å®¢æˆ·ç«¯ä¿¡æ¯ç»“æ„
```c
typedef struct {
    int client_fd;                  // å®¢æˆ·ç«¯socketæ–‡ä»¶æè¿°ç¬¦
    struct sockaddr_in client_addr; // å®¢æˆ·ç«¯åœ°å€ä¿¡æ¯
    connection_state_t state;       // è¿æ¥çŠ¶æ€
    time_t connect_time;           // è¿æ¥æ—¶é—´æˆ³
} client_info_t;
```

### è¿æ¥çŠ¶æ€ç®¡ç†
```c
typedef enum {
    CONN_DISCONNECTED = 0,          // æ–­å¼€çŠ¶æ€
    CONN_CONNECTING,                // è¿æ¥ä¸­
    CONN_CONNECTED,                 // å·²è¿æ¥
    CONN_ERROR                      // é”™è¯¯çŠ¶æ€
} connection_state_t;
```

### æ ¸å¿ƒç½‘ç»œå‡½æ•°
- `create_server_socket()` - åˆ›å»ºæœåŠ¡å™¨socket
- `create_client_socket()` - åˆ›å»ºå®¢æˆ·ç«¯socket
- `send_data()` - å®‰å…¨æ•°æ®å‘é€
- `receive_data()` - å¯é æ•°æ®æ¥æ”¶
- `close_socket()` - ä¼˜é›…è¿æ¥å…³é—­

## æŠ€æœ¯å®ç°

### æœåŠ¡å™¨ç«¯æ¶æ„ ([server.c](src/network/server.c))

#### ä¸»è¦ç‰¹æ€§
1. **å¤šå®¢æˆ·ç«¯æ”¯æŒ** - ä½¿ç”¨select()å®ç°å¹¶å‘è¿æ¥å¤„ç†
2. **éé˜»å¡I/O** - æ”¯æŒå¼‚æ­¥ç½‘ç»œæ“ä½œ
3. **è¿æ¥ç®¡ç†** - å®Œæ•´çš„å®¢æˆ·ç«¯è¿æ¥ç”Ÿå‘½å‘¨æœŸç®¡ç†
4. **é”™è¯¯å¤„ç†** - å¥å£®çš„ç½‘ç»œé”™è¯¯å¤„ç†æœºåˆ¶

#### æ ¸å¿ƒæµç¨‹
1. **æœåŠ¡å™¨åˆå§‹åŒ–** - åˆ›å»ºç›‘å¬socketï¼Œç»‘å®šç«¯å£
2. **è¿æ¥æ¥å—** - æ¥å—å®¢æˆ·ç«¯è¿æ¥è¯·æ±‚
3. **æ•°æ®å¤„ç†** - å¤„ç†å®¢æˆ·ç«¯æ•°æ®å¹¶å›æ˜¾
4. **è¿æ¥æ¸…ç†** - ä¼˜é›…å¤„ç†è¿æ¥æ–­å¼€

```c
// æœåŠ¡å™¨ä¸»å¾ªç¯ç¤ºä¾‹
static ssh_result_t server_main_loop(int server_fd) {
    fd_set master_set, read_set;
    int max_fd = server_fd;
    client_info_t clients[MAX_CLIENTS];
    
    FD_ZERO(&master_set);
    FD_SET(server_fd, &master_set);
    
    while (running) {
        read_set = master_set;
        
        if (select(max_fd + 1, &read_set, NULL, NULL, NULL) == -1) {
            return SSH_ERROR_NETWORK;
        }
        
        // å¤„ç†æ–°è¿æ¥å’Œå®¢æˆ·ç«¯æ•°æ®...
    }
}
```

### å®¢æˆ·ç«¯æ¶æ„ ([client.c](src/network/client.c))

#### ä¸»è¦ç‰¹æ€§
1. **äº¤äº’å¼ç•Œé¢** - æ”¯æŒç”¨æˆ·å®æ—¶è¾“å…¥
2. **å¼‚æ­¥é€šä¿¡** - åŒæ—¶å¤„ç†ç”¨æˆ·è¾“å…¥å’ŒæœåŠ¡å™¨å“åº”
3. **è¿æ¥ç®¡ç†** - è‡ªåŠ¨é‡è¿å’Œé”™è¯¯æ¢å¤
4. **å‘½ä»¤æ”¯æŒ** - æ”¯æŒquit/exitä¼˜é›…é€€å‡º

#### æ ¸å¿ƒæµç¨‹
1. **è¿æ¥å»ºç«‹** - è¿æ¥åˆ°æŒ‡å®šæœåŠ¡å™¨
2. **ç”¨æˆ·äº¤äº’** - å¤„ç†ç”¨æˆ·è¾“å…¥å‘½ä»¤
3. **æ•°æ®é€šä¿¡** - å‘é€æ•°æ®å¹¶æ¥æ”¶å“åº”
4. **çŠ¶æ€æ˜¾ç¤º** - å®æ—¶æ˜¾ç¤ºè¿æ¥çŠ¶æ€å’ŒæœåŠ¡å™¨å“åº”

```c
// å®¢æˆ·ç«¯ä¸»å¾ªç¯ç¤ºä¾‹
static ssh_result_t client_main_loop(client_context_t *client) {
    fd_set read_set;
    
    while (client->state == CONN_CONNECTED) {
        FD_ZERO(&read_set);
        FD_SET(STDIN_FILENO, &read_set);
        FD_SET(client->server_fd, &read_set);
        
        if (select(client->server_fd + 1, &read_set, NULL, NULL, NULL) > 0) {
            if (FD_ISSET(STDIN_FILENO, &read_set)) {
                handle_user_input(client);
            }
            if (FD_ISSET(client->server_fd, &read_set)) {
                handle_server_response(client);
            }
        }
    }
}
```

### ç½‘ç»œå·¥å…·åº“ ([socket_utils.c](src/network/socket_utils.c))

#### æ ¸å¿ƒåŠŸèƒ½
1. **Socketåˆ›å»ºå’Œé…ç½®**
   - TCP socketåˆ›å»ºå’Œé€‰é¡¹è®¾ç½®
   - åœ°å€ç»‘å®šå’Œç«¯å£ç®¡ç†
   - è¿æ¥å»ºç«‹å’Œç›‘å¬

2. **æ•°æ®ä¼ è¾“**
   - å¯é çš„æ•°æ®å‘é€å‡½æ•°
   - å®‰å…¨çš„æ•°æ®æ¥æ”¶å‡½æ•°
   - ç¼“å†²åŒºç®¡ç†å’Œè¾¹ç•Œæ£€æŸ¥

3. **é”™è¯¯å¤„ç†**
   - è¯¦ç»†çš„é”™è¯¯ç å®šä¹‰
   - é”™è¯¯ä¿¡æ¯å­—ç¬¦ä¸²è½¬æ¢
   - ç½‘ç»œå¼‚å¸¸æ¢å¤æœºåˆ¶

4. **è¿æ¥ç®¡ç†**
   - ä¼˜é›…çš„è¿æ¥å»ºç«‹
   - å®‰å…¨çš„è¿æ¥å…³é—­
   - è¿æ¥çŠ¶æ€è·Ÿè¸ª

```c
// æ•°æ®å‘é€å‡½æ•°ç¤ºä¾‹
ssh_result_t send_data(int socket_fd, const void *data, size_t length) {
    if (socket_fd < 0 || !data || length == 0) {
        return SSH_ERROR_INVALID_PARAM;
    }
    
    ssize_t total_sent = 0;
    const uint8_t *ptr = (const uint8_t *)data;
    
    while (total_sent < (ssize_t)length) {
        ssize_t sent = send(socket_fd, ptr + total_sent, 
                           length - total_sent, MSG_NOSIGNAL);
        if (sent <= 0) {
            if (errno == EAGAIN || errno == EWOULDBLOCK) {
                continue;
            }
            return SSH_ERROR_NETWORK;
        }
        total_sent += sent;
    }
    
    return SSH_OK;
}
```

## æµ‹è¯•éªŒè¯

### ç¼–è¯‘å’Œè¿è¡Œ
```bash
# ç¼–è¯‘é¡¹ç›®
make ssh_server ssh_client

# å¯åŠ¨æœåŠ¡å™¨ï¼ˆç»ˆç«¯1ï¼‰
./build/ssh_server

# å¯åŠ¨å®¢æˆ·ç«¯ï¼ˆç»ˆç«¯2ï¼‰
./build/ssh_client
```

### åŠŸèƒ½æµ‹è¯•
1. **åŸºç¡€è¿é€šæ€§æµ‹è¯•**
   - å®¢æˆ·ç«¯æˆåŠŸè¿æ¥æœåŠ¡å™¨
   - æ•°æ®èƒ½å¤ŸåŒå‘ä¼ è¾“
   - è¿æ¥çŠ¶æ€æ­£ç¡®æ˜¾ç¤º

2. **äº¤äº’å¼æµ‹è¯•**
   - ç”¨æˆ·è¾“å…¥å®æ—¶ä¼ é€
   - æœåŠ¡å™¨å›æ˜¾æ­£ç¡®æ˜¾ç¤º
   - quit/exitå‘½ä»¤æ­£å¸¸å·¥ä½œ

3. **å¹¶å‘è¿æ¥æµ‹è¯•**
   - å¤šä¸ªå®¢æˆ·ç«¯åŒæ—¶è¿æ¥
   - æ¯ä¸ªè¿æ¥ç‹¬ç«‹å¤„ç†
   - èµ„æºæ­£ç¡®é‡Šæ”¾

4. **å¼‚å¸¸æƒ…å†µæµ‹è¯•**
   - ç½‘ç»œæ–­å¼€æ¢å¤
   - éæ³•è¾“å…¥å¤„ç†
   - èµ„æºæ³„æ¼æ£€æŸ¥

## é¡¹ç›®ç»“æ„

```
src/
â”œâ”€â”€ network/
â”‚   â”œâ”€â”€ server.c               # TCPæœåŠ¡å™¨å®ç°
â”‚   â”œâ”€â”€ client.c               # TCPå®¢æˆ·ç«¯å®ç°
â”‚   â”œâ”€â”€ socket_utils.c         # ç½‘ç»œå·¥å…·å‡½æ•°
â”‚   â””â”€â”€ socket_utils.h         # ç½‘ç»œå·¥å…·å¤´æ–‡ä»¶
â”œâ”€â”€ common/
â”‚   â”œâ”€â”€ common.h               # é€šç”¨å®šä¹‰å’Œå®
â”‚   â””â”€â”€ logger.c               # æ—¥å¿—ç³»ç»Ÿå®ç°
build/
â”œâ”€â”€ ssh_server                 # æœåŠ¡å™¨å¯æ‰§è¡Œæ–‡ä»¶
â”œâ”€â”€ ssh_client                 # å®¢æˆ·ç«¯å¯æ‰§è¡Œæ–‡ä»¶
test/
â”œâ”€â”€ test_stage1.sh             # é˜¶æ®µ1æµ‹è¯•è„šæœ¬
â””â”€â”€ STAGE1_COMPLETE.md         # æœ¬æŠ¥å‘Šæ–‡ä»¶
```

## å…³é”®ç‰¹æ€§

### 1. å¯é æ€§
- å®Œå–„çš„é”™è¯¯å¤„ç†æœºåˆ¶
- ç½‘ç»œå¼‚å¸¸è‡ªåŠ¨æ¢å¤
- èµ„æºå®‰å…¨é‡Šæ”¾

### 2. æ€§èƒ½
- éé˜»å¡I/Oæ“ä½œ
- é«˜æ•ˆçš„select()å¤šè·¯å¤ç”¨
- æœ€å°åŒ–å†…å­˜å ç”¨

### 3. å¯æ‰©å±•æ€§
- æ¨¡å—åŒ–è®¾è®¡æ¶æ„
- æ¸…æ™°çš„æ¥å£å®šä¹‰
- æ˜“äºåŠŸèƒ½æ‰©å±•

### 4. æ˜“ç”¨æ€§
- ç®€æ´çš„å‘½ä»¤è¡Œç•Œé¢
- å®æ—¶çŠ¶æ€åé¦ˆ
- ç›´è§‚çš„æ“ä½œæ–¹å¼

## æˆæœæ€»ç»“

### âœ… å®ŒæˆåŠŸèƒ½
- **TCPæœåŠ¡å™¨** - æ”¯æŒå¤šå®¢æˆ·ç«¯å¹¶å‘è¿æ¥
- **TCPå®¢æˆ·ç«¯** - äº¤äº’å¼ç”¨æˆ·ç•Œé¢
- **æ•°æ®ä¼ è¾“** - å¯é çš„åŒå‘é€šä¿¡
- **è¿æ¥ç®¡ç†** - å®Œæ•´çš„ç”Ÿå‘½å‘¨æœŸç®¡ç†
- **é”™è¯¯å¤„ç†** - å¥å£®çš„å¼‚å¸¸å¤„ç†æœºåˆ¶
- **æ—¥å¿—ç³»ç»Ÿ** - å®Œå–„çš„è°ƒè¯•å’Œç›‘æ§

### ğŸ“Š æŠ€æœ¯æŒ‡æ ‡
- **å¹¶å‘è¿æ¥** - æ”¯æŒæœ€å¤§64ä¸ªå®¢æˆ·ç«¯
- **æ•°æ®ç¼“å†²** - 8KBå‘é€/æ¥æ”¶ç¼“å†²åŒº
- **å“åº”æ—¶é—´** - æ¯«ç§’çº§æ•°æ®ä¼ è¾“å»¶è¿Ÿ
- **å†…å­˜å ç”¨** - å•è¿æ¥çº¦1KBå†…å­˜ä½¿ç”¨
- **é”™è¯¯ç‡** - ç½‘ç»œé€šä¿¡é”™è¯¯è‡ªåŠ¨æ¢å¤

### ğŸ¯ ä¸ºåç»­é˜¶æ®µå¥ å®šåŸºç¡€
- **ç¨³å®šçš„ç½‘ç»œå±‚** - ä¸ºSSHåè®®å®ç°æä¾›å¯é åŸºç¡€
- **æ¨¡å—åŒ–æ¶æ„** - ä¾¿äºé›†æˆSSHåè®®åŠŸèƒ½
- **å®Œå–„çš„å·¥å…·åº“** - ä¸ºåŠ å¯†é€šä¿¡æä¾›åº•å±‚æ”¯æŒ
- **è°ƒè¯•æœºåˆ¶** - ä¸ºå¤æ‚åè®®è°ƒè¯•æä¾›æ—¥å¿—æ”¯æŒ

## æŠ€æœ¯å€ºåŠ¡å’Œæ”¹è¿›å»ºè®®

### å·²çŸ¥é™åˆ¶
1. **è¿æ¥æ•°é™åˆ¶** - å½“å‰æ”¯æŒæœ€å¤§64ä¸ªå¹¶å‘è¿æ¥
2. **å†…å­˜ç®¡ç†** - å¯è¿›ä¸€æ­¥ä¼˜åŒ–å†…å­˜ä½¿ç”¨æ•ˆç‡
3. **å¹³å°å…¼å®¹** - ä¸»è¦é’ˆå¯¹Linuxå¹³å°ä¼˜åŒ–

### æœªæ¥æ”¹è¿›æ–¹å‘
1. **æ€§èƒ½ä¼˜åŒ–** - å¼•å…¥epollç­‰æ›´é«˜æ•ˆçš„I/Oæœºåˆ¶
2. **å®‰å…¨å¢å¼º** - æ·»åŠ åŸºç¡€çš„è¾“å…¥éªŒè¯å’Œç¼“å†²åŒºä¿æŠ¤
3. **ç›‘æ§åŠŸèƒ½** - å¢åŠ è¿æ¥ç»Ÿè®¡å’Œæ€§èƒ½ç›‘æ§
4. **é…ç½®åŒ–** - æ”¯æŒé…ç½®æ–‡ä»¶å’Œå‘½ä»¤è¡Œå‚æ•°

---

**é˜¶æ®µä¸€ä¸ºæ•´ä¸ªSSHé¡¹ç›®å¥ å®šäº†åšå®çš„ç½‘ç»œé€šä¿¡åŸºç¡€ï¼ŒæˆåŠŸå®ç°äº†é«˜è´¨é‡çš„TCPå®¢æˆ·ç«¯/æœåŠ¡å™¨é€šä¿¡åŠŸèƒ½ï¼Œä¸ºåç»­SSHåè®®çš„å¤æ‚åŠŸèƒ½å®ç°æä¾›äº†ç¨³å®šå¯é çš„ç½‘ç»œå±‚æ”¯æŒã€‚**
